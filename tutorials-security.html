<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Distributed Publish &amp; Subscribe for IoT: Securing the communications</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Distributed Publish &amp; Subscribe for IoT
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('tutorials-security.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Securing the communications </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#enabling-network-layer-security">Enabling network layer security</a><ul><li class="level2"><a href="#dtls-with-pre-shared-keys">DTLS with pre-shared keys</a></li>
<li class="level2"><a href="#dtls-with-certificates">DTLS with certificates</a></li>
</ul>
</li>
<li class="level1"><a href="#protecting-the-payload">Protecting the payload</a><ul><li class="level2"><a href="#encrypting-with-a-symmetric-key">Encrypting with a symmetric key</a></li>
<li class="level2"><a href="#encrypting-with-an-asymmetric-key">Encrypting with an asymmetric key</a></li>
</ul>
</li>
<li class="level1"><a href="#authenticating-the-message-sender">Authenticating the message sender</a></li>
<li class="level1"><a href="#adding-access-control">Adding access control</a><ul><li class="level2"><a href="#defining-a-policy">Defining a policy</a></li>
<li class="level2"><a href="#implementing-subscription-control">Implementing subscription control</a></li>
<li class="level2"><a href="#implementing-publication-control">Implementing publication control</a></li>
<li class="level2"><a href="#implementing-acknowledgement-control">Implementing acknowledgement control</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="enabling-network-layer-security"></a>
Enabling network layer security</h1>
<p>Network layer security can be used to secure unicast communications between two nodes (a single hop). This includes the subscription, acknowledgement, and subscription acknowledgement messages. When the two nodes are <a class="el" href="tutorials-link.html">linked </a>, it also includes publications. Multicast publications are not secured. One of the end-to-end mechanisms described below must be used to secure multicast publications.</p>
<p>The first step to enabling network layer security is to build with a transport that supports it.</p>
<div class="fragment"><div class="line">$ scons transport=dtls</div></div><!-- fragment --><p>The DTLS transport supports two mechanisms for securing the connection: pre-shared keys, and certificates.</p>
<h2><a class="anchor" id="dtls-with-pre-shared-keys"></a>
DTLS with pre-shared keys</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#define BYTE_STR(s) { (const uint8_t*)s, sizeof(s) - 1 }</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key.html">DPS_Key</a> PSK = { <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a662c1e84628d96be8ae08163af382392">DPS_KEY_SYMMETRIC</a>, { .symmetric = BYTE_STR(<span class="stringliteral">&quot;1234&quot;</span>) } };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a> PSK_ID = BYTE_STR(<span class="stringliteral">&quot;Tutorial Network PSK&quot;</span>);</div></div><!-- fragment --><p>To use pre-shared keys (PSKs), we'll need to agree on a PSK and its identifier. <code>BYTE_STR</code> is a convenience macro used in the tutorials for using strings anywhere a buffer and its length is expected in the APIs.</p>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *separators = <span class="stringliteral">&quot;/.&quot;</span>;</div><div class="line">    <a class="code" href="group__keystore.html#gaf3833cfe48f848f698514bc5daa075fa">DPS_KeyStore</a>* keyStore = <a class="code" href="group__keystore.html#gafa79de23848ff56d0cced67897313369">DPS_CreateKeyStore</a>(PskAndIdHandler, PskHandler, NULL, NULL);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId = NULL;</div><div class="line">    <a class="code" href="group__node.html#ga4dd612ab965134321bb57fdb065f121c">DPS_Node</a>* node = <a class="code" href="group__node.html#gaf6641b5bbf27b2c45ac7f926b0ce4efe">DPS_CreateNode</a>(separators, keyStore, keyId);</div><div class="line">    <span class="keywordflow">if</span> (!node) {</div><div class="line">        <span class="keywordflow">goto</span> Exit;</div><div class="line">    }</div></div><!-- fragment --><p>All of the security mechanisms require that the node be created with a key store. The DTLS PSK mechanism requires that a <a class="el" href="group__keystore.html#ga83d3ade4f4acd7d4385d606270ddfd29">DPS_KeyAndIdHandler</a> and <a class="el" href="group__keystore.html#gaccf7e3d43bc1e586132d7f1ae03d02f7">DPS_KeyHandler</a> be provided.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__status.html#ga30395a84d3cad9d4ec29848106415038">DPS_Status</a> PskAndIdHandler(<a class="code" href="group__keystore.html#ga7c3e50965b65334e9791780fa855ed16">DPS_KeyStoreRequest</a>* request)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga289b1c74c01c9988f04297aa082986de">DPS_SetKeyAndId</a>(request, &amp;PSK, &amp;PSK_ID);</div><div class="line">}</div></div><!-- fragment --><p>The key and identifier handler simply uses <a class="el" href="group__keystore.html#ga289b1c74c01c9988f04297aa082986de" title="Provide a key and key identifier to a key store request. ">DPS_SetKeyAndId()</a> to return the PSK and identifier we agreed on earlier.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> IsSameKeyId(<span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* a, <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* b)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> (a-&gt;<a class="code" href="struct___d_p_s___key_id.html#ad656ed0567e09b47f95776e8af0f29df">len</a> == b-&gt;<a class="code" href="struct___d_p_s___key_id.html#ad656ed0567e09b47f95776e8af0f29df">len</a>) &amp;&amp; !memcmp(a-&gt;<a class="code" href="struct___d_p_s___key_id.html#a199ba6a4d89e6eab2b1c7f84db7b0e47">id</a>, b-&gt;<a class="code" href="struct___d_p_s___key_id.html#a199ba6a4d89e6eab2b1c7f84db7b0e47">id</a>, a-&gt;<a class="code" href="struct___d_p_s___key_id.html#ad656ed0567e09b47f95776e8af0f29df">len</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group__status.html#ga30395a84d3cad9d4ec29848106415038">DPS_Status</a> PskHandler(<a class="code" href="group__keystore.html#ga7c3e50965b65334e9791780fa855ed16">DPS_KeyStoreRequest</a>* request, <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (IsSameKeyId(keyId, &amp;PSK_ID)) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;PSK);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>;</div><div class="line">}</div></div><!-- fragment --><p>The key handler is used for PSKs as well as other keys, so it must compare the incoming <code>keyId</code> against the PSK identifier and either return the PSK using <a class="el" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab" title="Provide a key to a key store request. ">DPS_SetKey()</a> or return <a class="el" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group__keystore.html#ga2da4c5f9b7ab5ff6b65d1c8f4d6c30bc" title="Creates an in-memory key store. ">DPS_CreateMemoryKeyStore()</a>, <a class="el" href="group__keystore.html#ga8664b8c5cc2d3df6512ecb71e7f92212" title="Create or replace the network key in the key store. ">DPS_SetNetworkKey()</a></dd></dl>
<h2><a class="anchor" id="dtls-with-certificates"></a>
DTLS with certificates</h2>
<div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* CA_CERTIFICATE;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a> keyId;</div><div class="line">    <a class="code" href="struct___d_p_s___key.html">DPS_Key</a> key;</div><div class="line">} Certificate;</div><div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> Certificate CERTIFICATES[];</div><div class="line"><span class="preprocessor">#include &quot;tutorial_certs.c&quot;</span></div></div><!-- fragment --><p>To use certificates, we'll need a certificate for each node and the certificates of the authorities that issued them. DPS supports Elliptic Curve Cryptography (ECC) certificates. The certificates above are omitted due to their size.</p>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *separators = <span class="stringliteral">&quot;/.&quot;</span>;</div><div class="line">    <a class="code" href="group__keystore.html#gaf3833cfe48f848f698514bc5daa075fa">DPS_KeyStore</a>* keyStore = <a class="code" href="group__keystore.html#gafa79de23848ff56d0cced67897313369">DPS_CreateKeyStore</a>(NULL, CertificateHandler,</div><div class="line">                                                NULL, CertificateAuthoritiesHandler);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId = nodeId;</div><div class="line">    <a class="code" href="group__node.html#ga4dd612ab965134321bb57fdb065f121c">DPS_Node</a>* node = <a class="code" href="group__node.html#gaf6641b5bbf27b2c45ac7f926b0ce4efe">DPS_CreateNode</a>(separators, keyStore, keyId);</div><div class="line">    <span class="keywordflow">if</span> (!node) {</div><div class="line">        <span class="keywordflow">goto</span> Exit;</div><div class="line">    }</div></div><!-- fragment --><p>Again, all of the security mechanisms require that the node be created with a key store. The DTLS certificate mechanism requires that a <a class="el" href="group__keystore.html#gaccf7e3d43bc1e586132d7f1ae03d02f7">DPS_KeyHandler</a> and <a class="el" href="group__keystore.html#ga0acd005f34bca4fcbe1c460e2305ddae">DPS_CAHandler</a> be provided.</p>
<p>The certificate mechanism also requires that the <code>keyId</code> parameter be provided. This is the key identifier of the public key (<a class="el" href="struct___d_p_s___key_cert.html#a2783654ef73f2cc58911f40cd6e4f6ba">_DPS_KeyCert::cert</a>), private key (<a class="el" href="struct___d_p_s___key_cert.html#a0ba1842f3982c930ba76469349b0812d">_DPS_KeyCert::privateKey</a>), and optional password (<a class="el" href="struct___d_p_s___key_cert.html#a18f3f492b66fbeb3de6a09aff54369cf">_DPS_KeyCert::password</a>) of the created node. This <code>keyId</code> value will be provided to the <a class="el" href="group__keystore.html#gaccf7e3d43bc1e586132d7f1ae03d02f7">DPS_KeyHandler</a> when the node's own certificate is requested.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__status.html#ga30395a84d3cad9d4ec29848106415038">DPS_Status</a> CertificateAuthoritiesHandler(<a class="code" href="group__keystore.html#ga7c3e50965b65334e9791780fa855ed16">DPS_KeyStoreRequest</a>* request)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga37595f3207e42c52f7006659399135b2">DPS_SetCA</a>(request, CA_CERTIFICATE);</div><div class="line">}</div></div><!-- fragment --><p>The certificate authorities handler simply uses <a class="el" href="group__keystore.html#ga37595f3207e42c52f7006659399135b2" title="Provide a trusted CA chain to a key store request. ">DPS_SetCA()</a> to return the certificate authorities we trust. To include more than one certificate as shown in this example, concatenate the certificates together.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__status.html#ga30395a84d3cad9d4ec29848106415038">DPS_Status</a> CertificateHandler(<a class="code" href="group__keystore.html#ga7c3e50965b65334e9791780fa855ed16">DPS_KeyStoreRequest</a>* request, <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> Certificate* certificate;</div><div class="line">    <span class="keywordflow">for</span> (certificate = CERTIFICATES; certificate-&gt;keyId.id; ++certificate) {</div><div class="line">        <span class="keywordflow">if</span> (IsSameKeyId(keyId, &amp;certificate-&gt;keyId)) {</div><div class="line">            <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;certificate-&gt;key);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>;</div><div class="line">}</div></div><!-- fragment --><p>The key handler is used for certificates as well as other keys, so it must compare the incoming <code>keyId</code> against the certificate identifier and either return the certificate using <a class="el" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab" title="Provide a key to a key store request. ">DPS_SetKey()</a> or return <a class="el" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>.</p>
<p>Only the certificate with the key identifier provided to <a class="el" href="group__node.html#gaf6641b5bbf27b2c45ac7f926b0ce4efe" title="Allocates space for a local DPS node. ">DPS_CreateNode()</a> needs to include the private key (<a class="el" href="struct___d_p_s___key_cert.html#a0ba1842f3982c930ba76469349b0812d">_DPS_KeyCert::privateKey</a>) and optional password (<a class="el" href="struct___d_p_s___key_cert.html#a18f3f492b66fbeb3de6a09aff54369cf">_DPS_KeyCert::password</a>). For all other certificates, the public key (<a class="el" href="struct___d_p_s___key_cert.html#a2783654ef73f2cc58911f40cd6e4f6ba">_DPS_KeyCert::cert</a>) is sufficient.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group__keystore.html#ga8d55f887ebbd6b0af80caa43bf77a088" title="Create or replace the trusted CA(s) in the key store. ">DPS_SetTrustedCA()</a>, <a class="el" href="group__keystore.html#ga7a8c6874dd5bff0a6391a5515b545e17" title="Create or replace a certificate in the key store. ">DPS_SetCertificate()</a></dd></dl>
<h1><a class="anchor" id="protecting-the-payload"></a>
Protecting the payload</h1>
<p>While network layer security allows us to secure the communications of a single hop, encrypting the payload allows us to secure the payload across multiple hops. The payload can only be decrypted by the receiving node.</p>
<p>Encrypting a payload uses two keys: the content encryption key that encrypts the payload and the key encryption key that encrypts the content encryption key. This indirection allows a single instance of the payload to be encrypted for multiple recipients.</p>
<p>The content encryption key is always an ephemeral AES key. The key encryption key may be a symmetric or asymmetric key.</p>
<h2><a class="anchor" id="encrypting-with-a-symmetric-key"></a>
Encrypting with a symmetric key</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t AES_256_KEY[<a class="code" href="group__keystore.html#ga02d2171bf3c24345e5f562cb3e181a57">DPS_AES_256_KEY_LEN</a>] = {</div><div class="line">    0x37, 0xf9, 0x6f, 0x85, 0x72, 0x0c, 0xa0, 0x1b, 0x85, 0x51, 0x50, 0x45, 0x22, 0xa7, 0x30, 0x55,</div><div class="line">    0x4f, 0x05, 0x9c, 0xc4, 0xf4, 0xbb, 0xa6, 0x37, 0xfc, 0x0a, 0x90, 0x53, 0x64, 0xe1, 0xb7, 0x9c</div><div class="line">};</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key.html">DPS_Key</a> SYMMETRIC_KEY = { <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a662c1e84628d96be8ae08163af382392">DPS_KEY_SYMMETRIC</a>, { .symmetric = { AES_256_KEY, <a class="code" href="group__keystore.html#ga02d2171bf3c24345e5f562cb3e181a57">DPS_AES_256_KEY_LEN</a> } } };</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a> SYMMETRIC_KEY_ID = BYTE_STR(<span class="stringliteral">&quot;Tutorial Symmetric Key&quot;</span>);</div></div><!-- fragment --><p>To use a symmetric key encryption key, we'll need to agree on its value and identifier.</p>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *separators = <span class="stringliteral">&quot;/.&quot;</span>;</div><div class="line">    <a class="code" href="group__keystore.html#gaf3833cfe48f848f698514bc5daa075fa">DPS_KeyStore</a>* keyStore = <a class="code" href="group__keystore.html#gafa79de23848ff56d0cced67897313369">DPS_CreateKeyStore</a>(NULL, SymmetricKeyHandler, EphemeralSymmetricKeyHandler, NULL);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId = NULL;</div><div class="line">    <a class="code" href="group__node.html#ga4dd612ab965134321bb57fdb065f121c">DPS_Node</a>* node = <a class="code" href="group__node.html#gaf6641b5bbf27b2c45ac7f926b0ce4efe">DPS_CreateNode</a>(separators, keyStore, keyId);</div><div class="line">    <span class="keywordflow">if</span> (!node) {</div><div class="line">        <span class="keywordflow">goto</span> Exit;</div><div class="line">    }</div></div><!-- fragment --><p>Again, all of the security mechanisms require that the node be created with a key store. The payload encryption mechanism requires that a <a class="el" href="group__keystore.html#gaccf7e3d43bc1e586132d7f1ae03d02f7">DPS_KeyHandler</a> and <a class="el" href="group__keystore.html#ga5b4cf102912eea802196d3e307c399ef">DPS_EphemeralKeyHandler</a> be provided.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__status.html#ga30395a84d3cad9d4ec29848106415038">DPS_Status</a> SymmetricKeyHandler(<a class="code" href="group__keystore.html#ga7c3e50965b65334e9791780fa855ed16">DPS_KeyStoreRequest</a>* request, <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (IsSameKeyId(keyId, &amp;SYMMETRIC_KEY_ID)) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;SYMMETRIC_KEY);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>;</div><div class="line">}</div></div><!-- fragment --><p>The key handler is used for symmetric keys as well as other keys, so it must compare the incoming <code>keyId</code> against the symmetric key encryption key identifier and either return the key using <a class="el" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab" title="Provide a key to a key store request. ">DPS_SetKey()</a> or return <a class="el" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__status.html#ga30395a84d3cad9d4ec29848106415038">DPS_Status</a> EphemeralSymmetricKeyHandler(<a class="code" href="group__keystore.html#ga7c3e50965b65334e9791780fa855ed16">DPS_KeyStoreRequest</a>* request, <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key.html">DPS_Key</a>* key)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct___d_p_s___key.html#a347677e64145828ed5b1191a8fdc71d5">type</a> == <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a662c1e84628d96be8ae08163af382392">DPS_KEY_SYMMETRIC</a>) {</div><div class="line">        uint8_t key[<a class="code" href="group__keystore.html#ga02d2171bf3c24345e5f562cb3e181a57">DPS_AES_256_KEY_LEN</a>];</div><div class="line">        GenerateRandomKey(key);</div><div class="line">        <a class="code" href="struct___d_p_s___key.html">DPS_Key</a> ephemeralKey = { <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a662c1e84628d96be8ae08163af382392">DPS_KEY_SYMMETRIC</a>, { .symmetric = { key, DPS_AES_256_KEY_LEN } } };</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;ephemeralKey);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>;</div><div class="line">}</div></div><!-- fragment --><p>The ephemeral key handler is used for symmetric keys as well as other keys, so it must examine the incoming <code>key</code> type to determine what type of ephemeral key to return. It creates a random key of the requested type and returns it using <a class="el" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab" title="Provide a key to a key store request. ">DPS_SetKey()</a>. If it cannot do that, it must return <a class="el" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>.</p>
<div class="fragment"><div class="line">            ret = <a class="code" href="group__publication.html#ga91471ddf6f66798e255b28b3e913144b">DPS_PublicationAddSubId</a>(pub, &amp;SYMMETRIC_KEY_ID);</div><div class="line">            <span class="keywordflow">if</span> (ret != <a class="code" href="group__status.html#ga0ea3dd37bc558859ae0cb5a4f79a4bdd">DPS_OK</a>) {</div><div class="line">                <span class="keywordflow">goto</span> Exit;</div><div class="line">            }</div></div><!-- fragment --><p>Lastly, we add the key encryption key identifier to the publication.</p>
<p>This may be called multiple times with different key identifiers for a single publication. This allows an application to, for example, associate topics with key identifiers and initialize and encrypt a publication with multiple topics.</p>
<p>Acknowledgement payloads will be protected using the same key encryption key identifier the recipient used to decrypt the publication.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group__keystore.html#ga1855a8efae53b90fa95aa5b97295c4ec" title="Create or replace a key with the specified key identifier in the key store. ">DPS_SetContentKey()</a></dd></dl>
<h2><a class="anchor" id="encrypting-with-an-asymmetric-key"></a>
Encrypting with an asymmetric key</h2>
<p>The steps necessary to use an asymmetric key encryption key are very similar to the steps needed to use a symmetric key encryption key, described above. Only the differences are highlighted below.</p>
<dl class="section note"><dt>Note</dt><dd>Acknowledgement payloads will be encrypted using the same asymmetric key identifier the recipient used to decrypt the publication. As this is an ephemeral key, the encryption will fail. For this reason it is recommended to use this mechanism only with <a class="el" href="tutorials-security.html#authenticating-the-message-sender">authenticated senders </a> which prevents this failure.</dd></dl>
<div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key.html">DPS_Key</a> ASYMMETRIC_KEY;</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a> ASYMMETRIC_KEY_ID = BYTE_STR(<span class="stringliteral">&quot;Tutorial Asymmetric Key&quot;</span>);</div></div><!-- fragment --><p>To use asymmetric key encryption keys, the publisher will need the public key (<a class="el" href="struct___d_p_s___key_cert.html#a2783654ef73f2cc58911f40cd6e4f6ba">_DPS_KeyCert::cert</a>) of each recipient and each recipient will also need the private key (<a class="el" href="struct___d_p_s___key_cert.html#a0ba1842f3982c930ba76469349b0812d">_DPS_KeyCert::privateKey</a>) and optional password (<a class="el" href="struct___d_p_s___key_cert.html#a18f3f492b66fbeb3de6a09aff54369cf">_DPS_KeyCert::password</a>). The term recipient is used here instead of subscriber since a single recipient key may be used by multiple subscribers.</p>
<p>For this example we are using only one recipient. DPS supports Elliptic Curve Cryptography (ECC) certificates. The certificate above is elided due to its size.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__status.html#ga30395a84d3cad9d4ec29848106415038">DPS_Status</a> EphemeralAsymmetricKeyHandler(<a class="code" href="group__keystore.html#ga7c3e50965b65334e9791780fa855ed16">DPS_KeyStoreRequest</a>* request, <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key.html">DPS_Key</a>* key)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct___d_p_s___key.html#a347677e64145828ed5b1191a8fdc71d5">type</a> == <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a662c1e84628d96be8ae08163af382392">DPS_KEY_SYMMETRIC</a>) {</div><div class="line">        uint8_t key[<a class="code" href="group__keystore.html#ga02d2171bf3c24345e5f562cb3e181a57">DPS_AES_256_KEY_LEN</a>];</div><div class="line">        GenerateRandomKey(key);</div><div class="line">        <a class="code" href="struct___d_p_s___key.html">DPS_Key</a> ephemeralKey = { <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a662c1e84628d96be8ae08163af382392">DPS_KEY_SYMMETRIC</a>, { .symmetric = { key, DPS_AES_256_KEY_LEN } } };</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;ephemeralKey);</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct___d_p_s___key.html#a347677e64145828ed5b1191a8fdc71d5">type</a> == <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a58453a89367757e523ac337232387d89">DPS_KEY_EC</a>) {</div><div class="line">        uint8_t x[66], y[66], d[66];</div><div class="line">        GenerateEphemeralKey(key-&gt;<a class="code" href="struct___d_p_s___key.html#a8cf482ff4fe81b774462469c5da9295f">ec</a>.<a class="code" href="struct___d_p_s___key_e_c.html#a9896c40cd0b6dd0bd05ac5831fc421d9">curve</a>, x, y, d);</div><div class="line">        <a class="code" href="struct___d_p_s___key.html">DPS_Key</a> ephemeralKey = { <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a58453a89367757e523ac337232387d89">DPS_KEY_EC</a>, { .ec = { key-&gt;<a class="code" href="struct___d_p_s___key.html#a8cf482ff4fe81b774462469c5da9295f">ec</a>.<a class="code" href="struct___d_p_s___key_e_c.html#a9896c40cd0b6dd0bd05ac5831fc421d9">curve</a>, x, y, d } } };</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;ephemeralKey);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>;</div><div class="line">}</div></div><!-- fragment --><p>The ephemeral key handler is used for both symmetric and asymmetric keys, so it must examine the incoming <code>key</code> type to determine what type of ephemeral key to return. For <a class="el" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a58453a89367757e523ac337232387d89">DPS_KEY_EC</a> types, the ECC curve must also be examined.</p>
<p>The ephemeral ECC key requested here is the ephemeral sender key. The actual key encryption key is derived from the sender and recipient ECC keys.</p>
<p>In either case, the key handler creates a random key of the requested type (and curve) and returns it using <a class="el" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab" title="Provide a key to a key store request. ">DPS_SetKey()</a>. If it cannot do that, it must return <a class="el" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>.</p>
<h1><a class="anchor" id="authenticating-the-message-sender"></a>
Authenticating the message sender</h1>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *separators = <span class="stringliteral">&quot;/.&quot;</span>;</div><div class="line">    <a class="code" href="group__keystore.html#gaf3833cfe48f848f698514bc5daa075fa">DPS_KeyStore</a>* keyStore = <a class="code" href="group__keystore.html#gafa79de23848ff56d0cced67897313369">DPS_CreateKeyStore</a>(NULL, KeyHandler, EphemeralKeyHandler, NULL);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId = nodeId;</div><div class="line">    <a class="code" href="group__node.html#ga4dd612ab965134321bb57fdb065f121c">DPS_Node</a>* node = <a class="code" href="group__node.html#gaf6641b5bbf27b2c45ac7f926b0ce4efe">DPS_CreateNode</a>(separators, keyStore, keyId);</div><div class="line">    <span class="keywordflow">if</span> (!node) {</div><div class="line">        <span class="keywordflow">goto</span> Exit;</div><div class="line">    }</div></div><!-- fragment --><p>Authenticating the sender requires that the <code>keyId</code> parameter be provided. This is the key identifier of the public key (<a class="el" href="struct___d_p_s___key_cert.html#a2783654ef73f2cc58911f40cd6e4f6ba">_DPS_KeyCert::cert</a>), private key (<a class="el" href="struct___d_p_s___key_cert.html#a0ba1842f3982c930ba76469349b0812d">_DPS_KeyCert::privateKey</a>), and optional password (<a class="el" href="struct___d_p_s___key_cert.html#a18f3f492b66fbeb3de6a09aff54369cf">_DPS_KeyCert::password</a>) of the created node. This <code>keyId</code> value will be provided to the <a class="el" href="group__keystore.html#gaccf7e3d43bc1e586132d7f1ae03d02f7">DPS_KeyHandler</a> when the node's own certificate is requested.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__status.html#ga30395a84d3cad9d4ec29848106415038">DPS_Status</a> KeyHandler(<a class="code" href="group__keystore.html#ga7c3e50965b65334e9791780fa855ed16">DPS_KeyStoreRequest</a>* request, <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> Certificate* certificate;</div><div class="line">    <span class="keywordflow">for</span> (certificate = CERTIFICATES; certificate-&gt;keyId.id; ++certificate) {</div><div class="line">        <span class="keywordflow">if</span> (IsSameKeyId(keyId, &amp;certificate-&gt;keyId)) {</div><div class="line">            <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;certificate-&gt;key);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (IsSameKeyId(keyId, &amp;SYMMETRIC_KEY_ID)) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;SYMMETRIC_KEY);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (IsSameKeyId(keyId, &amp;ASYMMETRIC_KEY_ID)) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;ASYMMETRIC_KEY);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>;</div><div class="line">}</div></div><!-- fragment --><p>The key handler implementation above supports all the mechanisms described so far.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__status.html#ga30395a84d3cad9d4ec29848106415038">DPS_Status</a> EphemeralKeyHandler(<a class="code" href="group__keystore.html#ga7c3e50965b65334e9791780fa855ed16">DPS_KeyStoreRequest</a>* request, <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key.html">DPS_Key</a>* key)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct___d_p_s___key.html#a347677e64145828ed5b1191a8fdc71d5">type</a> == <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a662c1e84628d96be8ae08163af382392">DPS_KEY_SYMMETRIC</a>) {</div><div class="line">        uint8_t key[<a class="code" href="group__keystore.html#ga02d2171bf3c24345e5f562cb3e181a57">DPS_AES_256_KEY_LEN</a>];</div><div class="line">        GenerateRandomKey(key);</div><div class="line">        <a class="code" href="struct___d_p_s___key.html">DPS_Key</a> ephemeralKey = { <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a662c1e84628d96be8ae08163af382392">DPS_KEY_SYMMETRIC</a>, { .symmetric = { key, DPS_AES_256_KEY_LEN } } };</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;ephemeralKey);</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key-&gt;<a class="code" href="struct___d_p_s___key.html#a347677e64145828ed5b1191a8fdc71d5">type</a> == <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a58453a89367757e523ac337232387d89">DPS_KEY_EC</a>) {</div><div class="line">        uint8_t x[66], y[66], d[66];</div><div class="line">        GenerateEphemeralKey(key-&gt;<a class="code" href="struct___d_p_s___key.html#a8cf482ff4fe81b774462469c5da9295f">ec</a>.<a class="code" href="struct___d_p_s___key_e_c.html#a9896c40cd0b6dd0bd05ac5831fc421d9">curve</a>, x, y, d);</div><div class="line">        <a class="code" href="struct___d_p_s___key.html">DPS_Key</a> ephemeralKey = { <a class="code" href="group__keystore.html#gga7ca1045749c725e9c4a1b4758b2a0196a58453a89367757e523ac337232387d89">DPS_KEY_EC</a>, { .ec = { key-&gt;<a class="code" href="struct___d_p_s___key.html#a8cf482ff4fe81b774462469c5da9295f">ec</a>.<a class="code" href="struct___d_p_s___key_e_c.html#a9896c40cd0b6dd0bd05ac5831fc421d9">curve</a>, x, y, d } } };</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__keystore.html#ga15d6a9b8256b67c2ec8b1d365a98dbab">DPS_SetKey</a>(request, &amp;ephemeralKey);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__status.html#ga5c46980c33492a8b76bffce081dbcba4">DPS_ERR_MISSING</a>;</div><div class="line">}</div></div><!-- fragment --><p>The ephemeral key handler implementation above supports all the mechanisms described so far.</p>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId = <a class="code" href="group__publication.html#ga1d7e81c2f0b19736a4f7a7195e5bd98d">DPS_PublicationGetSenderKeyId</a>(pub);</div><div class="line">    <a class="code" href="group__debug.html#gaf1d25cc7f1d2d92f96ba620217af28fd">DPS_PRINT</a>(<span class="stringliteral">&quot;sender=%.*s\n&quot;</span>, keyId-&gt;<a class="code" href="struct___d_p_s___key_id.html#ad656ed0567e09b47f95776e8af0f29df">len</a>, keyId-&gt;<a class="code" href="struct___d_p_s___key_id.html#a199ba6a4d89e6eab2b1c7f84db7b0e47">id</a>);</div></div><!-- fragment --><div class="fragment"><div class="line">    <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId = <a class="code" href="group__publication.html#ga9190b8fa3bad848fb428acd6c0c2b210">DPS_AckGetSenderKeyId</a>(pub);</div><div class="line">    <a class="code" href="group__debug.html#gaf1d25cc7f1d2d92f96ba620217af28fd">DPS_PRINT</a>(<span class="stringliteral">&quot;sender=%.*s\n&quot;</span>, keyId-&gt;<a class="code" href="struct___d_p_s___key_id.html#ad656ed0567e09b47f95776e8af0f29df">len</a>, keyId-&gt;<a class="code" href="struct___d_p_s___key_id.html#a199ba6a4d89e6eab2b1c7f84db7b0e47">id</a>);</div></div><!-- fragment --><p>In the publication or acknowledgement handler, the authenticated key identifier can be retrieved with <a class="el" href="group__publication.html#ga1d7e81c2f0b19736a4f7a7195e5bd98d" title="Get the key identifier of a publication. ">DPS_PublicationGetSenderKeyId()</a> or <a class="el" href="group__publication.html#ga9190b8fa3bad848fb428acd6c0c2b210" title="Get the key identifier of an acknowledgement, only valid with the body of the DPS_AcknowledgementHand...">DPS_AckGetSenderKeyId()</a>.</p>
<h1><a class="anchor" id="adding-access-control"></a>
Adding access control</h1>
<p>Adding access control is a matter of combining the existing mechanisms to enforce any policies the application needs. A simple example is shown below.</p>
<h2><a class="anchor" id="defining-a-policy"></a>
Defining a policy</h2>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *topic;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a> keyId;</div><div class="line">    <span class="keyword">enum</span> {</div><div class="line">        PUB = (1&lt;&lt;0),</div><div class="line">        SUB = (1&lt;&lt;1),</div><div class="line">        ACK = (1&lt;&lt;2)</div><div class="line">    } bits;</div><div class="line">} AccessControlEntry;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> AccessControlEntry AccessControlList[] = {</div><div class="line">    { <span class="stringliteral">&quot;a/b/c/d&quot;</span>, BYTE_STR(<span class="stringliteral">&quot;alice&quot;</span>), PUB       },</div><div class="line">    { <span class="stringliteral">&quot;a/b/c/d&quot;</span>, BYTE_STR(<span class="stringliteral">&quot;bob&quot;</span>),   SUB | ACK },</div><div class="line">    { <span class="stringliteral">&quot;a/b/c/d&quot;</span>, BYTE_STR(<span class="stringliteral">&quot;trudy&quot;</span>), SUB       },</div><div class="line">    { NULL,      { NULL, 0 },       0         }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> IsAllowed(<span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId, <span class="keywordtype">int</span> bits, <span class="keyword">const</span> <a class="code" href="group__publication.html#ga0d439693474aa54e27f3d45a054696ac">DPS_Publication</a>* pub)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> AccessControlEntry* ace;</div><div class="line">    <span class="keywordflow">for</span> (ace = AccessControlList; ace-&gt;keyId.id; ++ace) {</div><div class="line">        <span class="keywordflow">if</span> (IsSameKeyId(keyId, &amp;ace-&gt;keyId) &amp;&amp; (bits &amp; ace-&gt;bits)) {</div><div class="line">            <span class="keywordtype">size_t</span> i;</div><div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__publication.html#gaee6fc3b13484faacff0d26646778f777">DPS_PublicationGetNumTopics</a>(pub); ++i) {</div><div class="line">                <span class="keywordflow">if</span> (!strcmp(ace-&gt;topic, <a class="code" href="group__publication.html#ga143a5c6fbe0bdf1725e841f122582432">DPS_PublicationGetTopic</a>(pub, i))) {</div><div class="line">                    <span class="keywordflow">return</span> <a class="code" href="dps_8h.html#a4a173ed2665cea74e58558d99b377ab3">DPS_TRUE</a>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="dps_8h.html#ad8b397975a479b996ef223367d8835a9">DPS_FALSE</a>;</div><div class="line">}</div></div><!-- fragment --><p>In the above we will allow <code>alice</code> to publish to topic <code>a/b/c/d</code>, <code>bob</code> to subscribe and acknowledge to topic <code>a/b/c/d</code>, and <code>trudy</code> to subscribe to topic <code>a/b/c/d</code>.</p>
<p><code>IsAllowed</code> implements the policy by searching through the access control list for matching key identifiers and access bits and uses <a class="el" href="group__publication.html#gaee6fc3b13484faacff0d26646778f777" title="Get the number of topics in a publication. ">DPS_PublicationGetNumTopics()</a> and <a class="el" href="group__publication.html#ga143a5c6fbe0bdf1725e841f122582432" title="Get a topic for a publication. ">DPS_PublicationGetTopic()</a> to check the topic.</p>
<h2><a class="anchor" id="implementing-subscription-control"></a>
Implementing subscription control</h2>
<div class="fragment"><div class="line">    ret = <a class="code" href="group__publication.html#ga7b0709e28cb34d5a30b90e4142cd6c19">DPS_InitPublication</a>(pub, topics, numTopics, noWildCard, NULL, AcknowledgementHandler);</div><div class="line">    <span class="keywordflow">if</span> (ret != <a class="code" href="group__status.html#ga0ea3dd37bc558859ae0cb5a4f79a4bdd">DPS_OK</a>) {</div><div class="line">        <span class="keywordflow">goto</span> Exit;</div><div class="line">    }</div><div class="line">    <span class="keyword">const</span> AccessControlEntry* ace;</div><div class="line">    <span class="keywordflow">for</span> (ace = AccessControlList; ace-&gt;keyId.id; ++ace) {</div><div class="line">        <span class="keywordflow">if</span> (IsAllowed(&amp;ace-&gt;keyId, SUB, pub)) {</div><div class="line">            ret = <a class="code" href="group__publication.html#ga91471ddf6f66798e255b28b3e913144b">DPS_PublicationAddSubId</a>(pub, &amp;ace-&gt;keyId);</div><div class="line">            <span class="keywordflow">if</span> (ret != <a class="code" href="group__status.html#ga0ea3dd37bc558859ae0cb5a4f79a4bdd">DPS_OK</a>) {</div><div class="line">                <span class="keywordflow">goto</span> Exit;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div></div><!-- fragment --><p>After initializing the publication, we use <a class="el" href="group__publication.html#ga91471ddf6f66798e255b28b3e913144b" title="Adds a key identifier to use for encrypted publications. ">DPS_PublicationAddSubId()</a> to add only the key identifiers of allowed subscribers. Any other subscribers will be unable to decrypt the publication.</p>
<h2><a class="anchor" id="implementing-publication-control"></a>
Implementing publication control</h2>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId = <a class="code" href="group__publication.html#ga1d7e81c2f0b19736a4f7a7195e5bd98d">DPS_PublicationGetSenderKeyId</a>(pub);</div><div class="line">    <span class="keywordflow">if</span> (!IsAllowed(keyId, PUB, pub)) {</div><div class="line">        <a class="code" href="group__debug.html#gaf1d25cc7f1d2d92f96ba620217af28fd">DPS_PRINT</a>(<span class="stringliteral">&quot;Rejecting publication\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">    <span class="comment">/* Proceed with application handling of publication... */</span></div></div><!-- fragment --><p>In the publication handler before any application-specific handling is done, we use <a class="el" href="group__publication.html#ga1d7e81c2f0b19736a4f7a7195e5bd98d" title="Get the key identifier of a publication. ">DPS_PublicationGetSenderKeyId()</a> to first check if the sender is allowed to publish to the topic. If not, we reject the publication.</p>
<h2><a class="anchor" id="implementing-acknowledgement-control"></a>
Implementing acknowledgement control</h2>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <a class="code" href="struct___d_p_s___key_id.html">DPS_KeyId</a>* keyId = <a class="code" href="group__publication.html#ga9190b8fa3bad848fb428acd6c0c2b210">DPS_AckGetSenderKeyId</a>(pub);</div><div class="line">    <span class="keywordflow">if</span> (!IsAllowed(keyId, ACK, pub)) {</div><div class="line">        <a class="code" href="group__debug.html#gac69225c4b8e73b27204a2963d4ca0633">DPS_ERRPRINT</a>(<span class="stringliteral">&quot;Rejecting acknowledgement\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">    <span class="comment">/* Proceed with application handling of acknowledgement... */</span></div></div><!-- fragment --><p>In the acknowledgement handler, before any application-specific handling is done, we use <a class="el" href="group__publication.html#ga9190b8fa3bad848fb428acd6c0c2b210" title="Get the key identifier of an acknowledgement, only valid with the body of the DPS_AcknowledgementHand...">DPS_AckGetSenderKeyId()</a> to first check if the sender is allowed to acknowledge the topic. If not, we reject the acknowledgement. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div class="navpath" id="nav-path">
  <ul>
    <li class="footer" style="float:left"><b>Distributed Publish & Subscribe for IoT</b></li> <li class="footer">Generated Fri Jun 8 2018 15:56:01</li>
  </ul>
</div>
</body>
</html>
